<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Real-Time Accelerometer Viewer</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        #status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 20px;
        }
        #device-status {
            font-size: 18px;
            font-weight: bold;
        }
        #temperature {
            font-size: 18px;
            font-weight: bold;
        }
        .online {
            color: green;
        }
        .offline {
            color: red;
        }
    </style>
</head>
<body>
    <div id="status-bar">
        <div id="device-status" class="offline">❌ Offline</div>
        <div id="temperature">Sensor Temp: -- °C</div>
    </div>
    <div id="chart" style="width: 100%; height: 800px;"></div>

    <script>
        const socket = io();

        let timeData = [];
        let acc_x = [], acc_y = [], acc_z = [];

        const maxPoints = 100;
        let deviceOnline = false;
        let lastDataTime = 0;

        const layout = {
            grid: { rows: 3, columns: 1, pattern: 'independent' },
            title: 'Accelerometer Data (X, Y, Z)',
            height: 800,
            showlegend: false
        };

        const traces = [
            {
                x: [], y: [], name: 'acc_x', mode: 'lines',
                line: { color: 'red' }, xaxis: 'x1', yaxis: 'y1'
            },
            {
                x: [], y: [], name: 'acc_y', mode: 'lines',
                line: { color: 'green' }, xaxis: 'x2', yaxis: 'y2'
            },
            {
                x: [], y: [], name: 'acc_z', mode: 'lines',
                line: { color: 'blue' }, xaxis: 'x3', yaxis: 'y3'
            },
        ];

        Plotly.newPlot('chart', traces, layout);

        // Monitor device status every 1s
        setInterval(() => {
            const now = Date.now();
            const elapsed = now - lastDataTime;

            if (elapsed > 1000) {
                deviceOnline = false;
                updateStatus(false);

                // Inject 0 data if device offline
                const t = new Date().toLocaleTimeString();
                timeData.push(t);
                acc_x.push(0);
                acc_y.push(0);
                acc_z.push(0);

                if (timeData.length > maxPoints) {
                    timeData.shift(); acc_x.shift(); acc_y.shift(); acc_z.shift();
                }

                Plotly.update('chart', {
                    x: [timeData, timeData, timeData],
                    y: [acc_x, acc_y, acc_z]
                });
            }
        }, 1000);

        // Handle incoming sensor data
        socket.on('sensor_data', data => {
            lastDataTime = Date.now();
            deviceOnline = true;
            updateStatus(true);

            const t = data.time;

            timeData.push(t);
            acc_x.push(data.acc_x);
            acc_y.push(data.acc_y);
            acc_z.push(data.acc_z);

            if (timeData.length > maxPoints) {
                timeData.shift(); acc_x.shift(); acc_y.shift(); acc_z.shift();
            }

            Plotly.update('chart', {
                x: [timeData, timeData, timeData],
                y: [acc_x, acc_y, acc_z]
            });

            // Update temperature
            document.getElementById('temperature').innerText =
                `Sensor Temp: ${data.temperature.toFixed(2)} °C`;
        });

        function updateStatus(isOnline) {
            const status = document.getElementById('device-status');
            if (isOnline) {
                status.textContent = "✅ Online";
                status.className = "online";
            } else {
                status.textContent = "❌ Offline";
                status.className = "offline";
            }
        }
    </script>
</body>
</html>
